<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriPal RAG AI Chatbot - Your Agricultural Assistant</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* âœ… Post-harvest style background overlay */
        #chatbot-page {
            position: relative;
            isolation: isolate;
        }

        /* Farmer background image */
        #chatbot-page::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://images.unsplash.com/photo-1592982537447-6f2a6b0013e0?w=1920&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            opacity: 0.10;
            z-index: -1;
        }

        /* Light overlay */
        #chatbot-page::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.78), rgba(255, 255, 255, 0.55));
            z-index: -1;
        }

        /* Chat container same as post-harvest card style */
        .chat-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            backdrop-filter: blur(10px);
        }

        .chat-messages {
            height: 600px;
            overflow-y: auto;
            scroll-behavior: smooth;
            background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);
        }

        .message {
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-content {
            max-width: 80%;
            padding: 15px 20px;
            border-radius: 20px;
            word-wrap: break-word;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message.bot .message-content {
            background: white;
            color: #333;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 5px;
        }

        /* Typing indicator */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            background: white;
            border-radius: 20px;
            border-bottom-left-radius: 5px;
            margin-bottom: 20px;
            max-width: 80%;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #16a34a;
            animation: typingDot 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingDot {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #22c55e;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.55; }
            100% { opacity: 1; }
        }

        .quick-action {
            transition: all 0.3s ease;
        }

        .quick-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.18);
        }

        .header-icon {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .back-btn {
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateX(-4px);
        }

        .rag-badge {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .direct-ai-badge {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        /* Markdown styling for bot responses */
        .message-content h1, .message-content h2, .message-content h3 {
            margin: 10px 0 5px 0;
            color: #2e7d32;
        }

        .message-content ul, .message-content ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .message-content li {
            margin: 5px 0;
        }

        .message-content strong {
            color: #2e7d32;
        }

        .message-content code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .message-content blockquote {
            border-left: 4px solid #4CAF50;
            margin: 10px 0;
            padding: 10px 15px;
            background: #f9f9f9;
            font-style: italic;
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- âœ… Navbar copied like Post-Harvest -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <i class="fas fa-leaf text-green-600 text-2xl header-icon"></i>
                    <span class="text-2xl font-bold text-gray-800">Agri<span class="text-green-600">Pal</span></span>
                </div>
                <div class="flex gap-4">
                    <a href="/" class="text-gray-600 hover:text-green-600 transition-colors px-3 py-2 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-home mr-2"></i>Home
                    </a>
                    <a href="/detection-tool" class="text-gray-600 hover:text-green-600 transition-colors px-3 py-2 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-microscope mr-2"></i>Detection
                    </a>
                    <a href="/post-harvest" class="text-gray-600 hover:text-green-600 transition-colors px-3 py-2 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-warehouse mr-2"></i>Post-Harvest
                    </a>
                    <a href="/chatbot" class="text-green-600 font-semibold px-3 py-2 rounded-lg bg-green-50">
                        <i class="fas fa-comments mr-2"></i>AI Chatbot
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Page -->
    <div id="chatbot-page" class="min-h-screen">
        <!-- Header Section -->
        <div class="bg-gradient-to-r from-green-700 via-green-600 to-green-700 text-white py-16 relative">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between mb-6">
                    <button onclick="window.history.back()" class="flex items-center text-white px-4 py-2 rounded-lg back-btn">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back
                    </button>
                    <div class="flex items-center gap-3">
                        <span class="text-green-100 text-sm" id="systemInfo">AI Status: Connecting...</span>
                        <div class="status-indicator" id="statusIndicator"></div>
                    </div>
                </div>

                <div class="text-center">
                    <i class="fas fa-robot text-6xl mb-4 header-icon"></i>
                    <h1 class="text-4xl font-bold mb-2">AgriPal RAG AI Assistant</h1>
                    <p class="text-green-100 text-lg mb-6">Your Intelligent Agricultural Knowledge Companion</p>

                    <!-- Mode Toggle -->
                    <div class="inline-flex items-center gap-3 bg-white/10 backdrop-blur-md px-6 py-3 rounded-full border border-white/20">
                        <span class="text-white text-sm font-medium">AgriPal RAG</span>

                        <label class="relative inline-block">
                            <input type="checkbox" id="directAiToggle" class="sr-only" onchange="toggleChatMode()">
                            <span class="relative w-[50px] h-[24px] block rounded-full cursor-pointer transition bg-white/30"
                                  style="position:relative;">
                                <span id="toggleKnob"
                                      class="absolute w-[18px] h-[18px] left-[3px] bottom-[3px] bg-white rounded-full transition"></span>
                            </span>
                        </label>

                        <span class="text-white text-sm font-medium">Direct Gemini AI</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Container -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="chat-container">
                <!-- Chat Header Info -->
                <div class="bg-gradient-to-r from-green-50 to-blue-50 px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center">
                                <i class="fas fa-seedling text-white"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800">AgriPal RAG AI</h3>
                                <p class="text-sm text-gray-600" id="chatModeLabel">RAG + Gemini 2.5 + Database</p>
                            </div>
                        </div>
                        <span class="rag-badge" id="modeBadge">
                            <i class="fas fa-database"></i>
                            RAG Enabled
                        </span>
                    </div>
                </div>

                <!-- Messages -->
                <div class="chat-messages p-6" id="chatMessages">
                    <div class="message bot">
                        <div class="message-content">
                            <div class="font-bold text-green-700 mb-2">
                                <i class="fas fa-leaf mr-2"></i>Namaste! Welcome to AgriPal RAG AI!
                            </div>
                            <div class="text-gray-700 mb-3">
                                I'm your intelligent agricultural assistant powered by:
                            </div>
                            <ul class="space-y-2 text-gray-700 mb-4">
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-robot text-green-600 mt-1"></i>
                                    <span><strong>Gemini 2.5 AI</strong> for expert reasoning</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-database text-blue-600 mt-1"></i>
                                    <span><strong>RAG System</strong> for accurate agricultural knowledge</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-server text-purple-600 mt-1"></i>
                                    <span><strong>Database</strong> for market prices & schemes</span>
                                </li>
                            </ul>

                            <div class="font-bold text-gray-800 mb-2">What I can help with:</div>
                            <ul class="space-y-1 text-sm text-gray-700 mb-4">
                                <li>ðŸ”¬ Disease Detection & Treatment Plans</li>
                                <li>ðŸ“Š Government Schemes & Subsidies</li>
                                <li>ðŸ’° Current Market Prices</li>
                                <li>ðŸŒ¾ Crop Cultivation Guides</li>
                                <li>ðŸ§ª Fertilizer & Pesticide Recommendations</li>
                            </ul>

                            <div class="flex flex-wrap gap-2 mt-4">
                                <button onclick="sendQuickMessage('questions')" class="quick-action bg-green-100 text-green-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-green-200">
                                    Common Questions
                                </button>
                                <button onclick="sendQuickMessage('help')" class="quick-action bg-blue-100 text-blue-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-blue-200">
                                    Help & Commands
                                </button>
                                <button onclick="sendQuickMessage('What crops to plant in monsoon?')" class="quick-action bg-purple-100 text-purple-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-purple-200">
                                    Monsoon Crops
                                </button>
                            </div>
                            <div class="text-xs text-gray-400 mt-3" id="welcomeTime"></div>
                        </div>
                    </div>
                </div>

                <!-- Typing -->
                <div class="px-6">
                    <div class="typing-indicator" id="typingIndicator">
                        <div class="text-sm text-gray-600">ðŸ¤– AgriPal AI is thinking</div>
                        <div class="flex gap-1">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>

                <!-- Input -->
                <div class="p-6 bg-gray-50 border-t border-gray-200">
                    <div class="flex gap-3 items-center">
                        <input
                            type="text"
                            id="chatInput"
                            class="flex-1 px-6 py-3 border-2 border-gray-300 rounded-full focus:border-green-500 focus:outline-none text-gray-800"
                            placeholder="Ask me anything about agriculture..."
                            onkeypress="handleKeyPress(event)"
                        >

                        <button
                            id="voiceButton"
                            onclick="toggleVoiceInput()"
                            class="w-12 h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-full flex items-center justify-center transition-all"
                            title="Voice Input"
                        >
                            <i class="fas fa-microphone"></i>
                        </button>

                        <button
                            id="sendButton"
                            onclick="sendMessage()"
                            class="w-12 h-12 bg-green-600 hover:bg-green-700 text-white rounded-full flex items-center justify-center transition-all"
                            title="Send Message"
                        >
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Info cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
                <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-brain text-green-600 text-xl"></i>
                    </div>
                    <h3 class="font-bold text-gray-800 mb-2">RAG Technology</h3>
                    <p class="text-sm text-gray-600">Retrieval-Augmented Generation ensures accurate, up-to-date agricultural information from verified sources.</p>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-shield-alt text-blue-600 text-xl"></i>
                    </div>
                    <h3 class="font-bold text-gray-800 mb-2">Reliable Data</h3>
                    <p class="text-sm text-gray-600">Information sourced from government databases, research papers, and verified agricultural experts.</p>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200">
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-clock text-purple-600 text-xl"></i>
                    </div>
                    <h3 class="font-bold text-gray-800 mb-2">24/7 Available</h3>
                    <p class="text-sm text-gray-600">Get instant answers to your agricultural questions anytime, anywhere, in multiple languages.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let conversationHistory = [];
        let isListening = false;
        let recognition = null;
        let systemStatus = { ai_connected: false, rag_available: false };
        let isDirectAiMode = false;
        let currentChatMode = 'agripal';

        document.addEventListener('DOMContentLoaded', function () {
            initializeChatbot();
            setupVoiceRecognition();
            setWelcomeTime();
            checkSystemStatus();
            loadChatMode();
            syncToggleKnob();
        });

        function syncToggleKnob() {
            const toggle = document.getElementById("directAiToggle");
            const knob = document.getElementById("toggleKnob");
            if (!knob) return;

            knob.style.transform = toggle.checked ? "translateX(26px)" : "translateX(0px)";
        }

        function loadChatMode() {
            const savedMode = localStorage.getItem('agripal_chat_mode');
            if (savedMode === 'direct_ai') {
                document.getElementById('directAiToggle').checked = true;
                toggleChatMode();
            }
            syncToggleKnob();
        }

        function toggleChatMode() {
            const toggle = document.getElementById('directAiToggle');
            const chatModeLabel = document.getElementById('chatModeLabel');
            const modeBadge = document.getElementById('modeBadge');
            const messagesContainer = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');

            isDirectAiMode = toggle.checked;
            currentChatMode = isDirectAiMode ? 'direct_ai' : 'agripal';

            // Update UI
            if (isDirectAiMode) {
                chatModeLabel.textContent = 'Direct Gemini AI';
                modeBadge.className = 'direct-ai-badge';
                modeBadge.innerHTML = '<i class="fas fa-robot"></i> Direct AI';
                chatInput.placeholder = "Ask Gemini AI anything...";
            } else {
                chatModeLabel.textContent = 'RAG + Gemini 2.5 + Database';
                modeBadge.className = 'rag-badge';
                modeBadge.innerHTML = '<i class="fas fa-database"></i> RAG Enabled';
                chatInput.placeholder = "Ask me anything about agriculture...";
            }

            localStorage.setItem('agripal_chat_mode', currentChatMode);

            // Clear chat
            messagesContainer.innerHTML = '';
            if (isDirectAiMode) showDirectAiWelcome();
            else showAgriPalWelcome();

            conversationHistory = [];
            syncToggleKnob();
        }

        function showDirectAiWelcome() {
            const messagesContainer = document.getElementById('chatMessages');
            const welcomeDiv = document.createElement('div');
            welcomeDiv.className = 'message bot';

            welcomeDiv.innerHTML = `
                <div class="message-content">
                    <div class="bg-gradient-to-r from-orange-100 to-red-100 p-4 rounded-lg mb-3">
                        <div class="font-bold text-orange-800 mb-1">ðŸ¤– Direct AI Mode Activated</div>
                        <div class="text-sm text-orange-700">You're now chatting directly with Gemini AI</div>
                    </div>

                    <div class="font-bold text-gray-800 mb-2">ðŸ§  Welcome to Direct Gemini AI Chat!</div>
                    <div class="text-gray-700 mb-3">Ask me anything. I can assist in any domain!</div>
                    <div class="text-xs text-gray-400 mt-3">${new Date().toLocaleTimeString()}</div>
                </div>
            `;

            messagesContainer.appendChild(welcomeDiv);
        }

        function showAgriPalWelcome() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = `
                <div class="message bot">
                    <div class="message-content">
                        <div class="font-bold text-green-700 mb-2">
                            <i class="fas fa-leaf mr-2"></i>Namaste! Welcome to AgriPal RAG AI!
                        </div>
                        <div class="text-gray-700 mb-3">
                            I'm your intelligent agricultural assistant powered by:
                        </div>
                        <ul class="space-y-2 text-gray-700 mb-4">
                            <li class="flex items-start gap-2">
                                <i class="fas fa-robot text-green-600 mt-1"></i>
                                <span><strong>Gemini 2.5 AI</strong> for expert reasoning</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <i class="fas fa-database text-blue-600 mt-1"></i>
                                <span><strong>RAG System</strong> for accurate agricultural knowledge</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <i class="fas fa-server text-purple-600 mt-1"></i>
                                <span><strong>Database</strong> for real-time data</span>
                            </li>
                        </ul>

                        <div class="font-bold text-gray-800 mb-2">What I can help with:</div>
                        <ul class="space-y-1 text-sm text-gray-700 mb-4">
                            <li>ðŸ”¬ Disease Detection & Treatment Plans</li>
                            <li>ðŸ“Š Government Schemes & Subsidies</li>
                            <li>ðŸ’° Current Market Prices</li>
                            <li>ðŸŒ¾ Crop Cultivation Guides</li>
                            <li>ðŸ§ª Fertilizer & Pesticide Recommendations</li>
                        </ul>

                        <div class="flex flex-wrap gap-2 mt-4">
                            <button onclick="sendQuickMessage('questions')" class="quick-action bg-green-100 text-green-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-green-200">
                                Common Questions
                            </button>
                            <button onclick="sendQuickMessage('help')" class="quick-action bg-blue-100 text-blue-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-blue-200">
                                Help & Commands
                            </button>
                        </div>
                        <div class="text-xs text-gray-400 mt-3">${new Date().toLocaleTimeString()}</div>
                    </div>
                </div>
            `;
        }

        function setWelcomeTime() {
            const welcomeTimeElement = document.getElementById('welcomeTime');
            if (welcomeTimeElement) welcomeTimeElement.textContent = new Date().toLocaleTimeString();
        }

        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/rag/status');
                const data = await response.json();
                systemStatus = data;
                updateSystemIndicators();
            } catch (error) {
                console.error('Error checking system status:', error);
                updateSystemIndicators(false);
            }
        }

        function updateSystemIndicators(connected = null) {
            const statusIndicator = document.getElementById('statusIndicator');
            const systemInfo = document.getElementById('systemInfo');

            const isConnected = connected !== null ? connected : systemStatus.rag_available;

            if (isConnected) {
                statusIndicator.style.background = '#22c55e';
                systemInfo.textContent = 'AI Status: Online';
            } else {
                statusIndicator.style.background = '#f59e0b';
                systemInfo.textContent = 'AI Status: Limited';
            }
        }

        function setupVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onstart = function () {
                    isListening = true;
                    document.getElementById('voiceButton').innerHTML = '<i class="fas fa-stop"></i>';
                    document.getElementById('voiceButton').classList.remove('bg-blue-600');
                    document.getElementById('voiceButton').classList.add('bg-red-600');
                };

                recognition.onend = function () {
                    isListening = false;
                    document.getElementById('voiceButton').innerHTML = '<i class="fas fa-microphone"></i>';
                    document.getElementById('voiceButton').classList.remove('bg-red-600');
                    document.getElementById('voiceButton').classList.add('bg-blue-600');
                };

                recognition.onresult = function (event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('chatInput').value = transcript;
                    sendMessage();
                };

                recognition.onerror = function (event) {
                    console.error('Speech recognition error:', event.error);
                };
            } else {
                document.getElementById('voiceButton').style.display = 'none';
            }
        }

        function toggleVoiceInput() {
            if (!recognition) return;
            if (isListening) recognition.stop();
            else recognition.start();
        }

        function initializeChatbot() {
            document.getElementById('chatInput').focus();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') sendMessage();
        }

        function sendQuickMessage(message) {
            document.getElementById('chatInput').value = message;
            sendMessage();
        }

        /* âœ… FULL sendMessage continuation (from your uploaded chatbot.html file) */
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            input.value = '';
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;

            addMessage('user', message);

            conversationHistory.push({
                role: 'user',
                text: message,
                timestamp: new Date().toISOString()
            });

            showTypingIndicator();

            try {
                let response, data;

                if (isDirectAiMode) {
                    response = await fetch('/api/chat/direct-ai', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: message,
                            history: conversationHistory.slice(-5)
                        })
                    });
                    data = await response.json();
                } else {
                    let detectedDisease = null;
                    try {
                        const diseaseResponse = await fetch('/get_detected_disease');
                        if (diseaseResponse.ok) {
                            const diseaseData = await diseaseResponse.json();
                            detectedDisease = diseaseData.disease;
                        }
                    } catch (e) {
                        console.log('No detected disease found');
                    }

                    response = await fetch('/api/chat/enhanced', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: message,
                            history: conversationHistory.slice(-5),
                            detected_disease: detectedDisease
                        })
                    });
                    data = await response.json();
                }

                if (data.success) {
                    updateSystemIndicators(data.ai_status === 'online');

                    const responsePrefix = isDirectAiMode ? 'ðŸ¤– **Gemini AI:**\n\n' : '';
                    addMessage('bot', responsePrefix + data.response);

                    conversationHistory.push({
                        role: 'bot',
                        text: data.response,
                        timestamp: data.timestamp || new Date().toISOString(),
                        ai_status: data.ai_status,
                        mode: currentChatMode
                    });

                    localStorage.setItem(`agripal_chat_history_${currentChatMode}`,
                        JSON.stringify(conversationHistory.slice(-20)));

                } else {
                    throw new Error(data.error || 'Unknown error occurred');
                }

            } catch (error) {
                console.error('Error sending message:', error);

                let fallbackResponse;
                if (isDirectAiMode) {
                    fallbackResponse = `ðŸ¤– **Direct AI Connection Issues**

I'm having trouble connecting to Gemini AI right now. This could be due to:
â€¢ Network connectivity issues
â€¢ API rate limits  
â€¢ Server maintenance

**Try:**
â€¢ Switching to AgriPal Mode for agricultural questions
â€¢ Refreshing the page
â€¢ Trying again in a few moments

**Alternative:** Use AgriPal mode for specialized agricultural assistance! ðŸŒ±`;
                } else {
                    fallbackResponse = `ðŸ¤– I'm experiencing technical difficulties right now. Here are some things you can try:

â€¢ **Type "questions"** to see common agricultural questions
â€¢ **Type "help"** to see available commands  
â€¢ **Ask specific questions** about crops, diseases, or treatments
â€¢ **Contact your local Krishi Vigyan Kendra** for immediate expert help

I'll be back online shortly! ðŸŒ±`;
                }

                addMessage('bot', fallbackResponse);

            } finally {
                hideTypingIndicator();
                sendButton.disabled = false;
                input.focus();
            }
        }

        function addMessage(sender, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (sender === 'bot') contentDiv.innerHTML = formatBotMessage(content);
            else contentDiv.textContent = content;

            const timeDiv = document.createElement('div');
            timeDiv.className = 'text-xs text-gray-400 mt-2 text-right';
            timeDiv.textContent = new Date().toLocaleTimeString();

            contentDiv.appendChild(timeDiv);
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function formatBotMessage(content) {
            let formatted = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>')
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>');

            formatted = formatted.replace(/^[â€¢Â·]\s*(.*$)/gim, '<li>$1</li>');
            formatted = formatted.replace(/(<li>.*<\/li>)/gs, function (match) {
                return '<ul>' + match + '</ul>';
            });

            return formatted;
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'flex';
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        // keep checking status
        setInterval(checkSystemStatus, 30000);
    </script>
</body>
</html>
